name: Nudge Codex on push

on:
  push:
    branches:
      - 'feat/**'
      - 'fix/**'
      - 'tweak/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  nudge:
    if: ${{ !github.event.created }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BRANCH: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Auth gh
        run: gh auth status || true

      - name: Find PR for this branch
        id: pr
        run: |
          PR_NUMBER=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')
          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR for $BRANCH"; exit 0
          fi
          echo "pr=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Post Codex trigger comment with instructions
        if: steps.pr.outputs.pr
        env:
          PR: ${{ steps.pr.outputs.pr }}
          GH_TOKEN: ${{ secrets.CODEX_TRIGGER_TOKEN }}
        run: |
          TMP=$(mktemp)
          {
            echo "@codex review"
            echo
            echo "instructions: .github/codex_instructions.md"
          } > "$TMP"

          gh pr comment "$PR" --body-file "$TMP"
